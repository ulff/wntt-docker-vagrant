machine:
  python:
    version: 2.7.3
  php:
    version: 5.5.11
  node:
    version: 0.10.33
  services:
    - mongodb
    - docker
  environment:
    SYMFONY__MONGO__HOST: mongo
    SYMFONY__MONGO__PORT: 27017

general:
  branches:
    ignore:
    - develop

dependencies:
  pre:
    - yes '' | pecl install mongo
    - rm -rf /home/ubuntu/wntt-docker-vagrant/vendor
    - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < .dockercfg.TEMPLATE > ~/.dockercfg
    - mkdir ~/.aws
    - bash -x bin/aws/prepare_slack_notify.sh
  post:
    - pip install awscli
    - chmod -R 777 app/cache
    - chmod -R 777 app/logs
    - docker build -t $PUBLIC_DOCKER/$PUBLIC_DOCKER_WWW_DIST:$CIRCLE_SHA1 .

test:
  override:
    - docker run -d --name mongo mongo
    - docker run -i -t --link mongo:mongo betavest/wntt-dist:$CIRCLE_SHA1 /var/www/bin/setup.sh
    - docker run -i -t --link mongo:mongo betavest/wntt-dist:$CIRCLE_SHA1 phing -find /var/www/build.xml test
    - docker kill mongo

deployment:
  PRV:
    branch: /US-WNTT-\d+/
    commands:
      - sed "s/<AWS_REGION>/$QA_AWS_REGION/" < .aws.config.TEMPLATE > ~/.aws/config
      - sed "s/<IMAGE_SHA>/$CIRCLE_SHA1/;s/<BUILD_ENVIRONMENT>/betavest-all/;s/<TARGET_DOCKER>/$PUBLIC_DOCKER/;s/<TARGET_DOCKER_DIST>/$PUBLIC_DOCKER_WWW_DIST/;s/<APPLICATION_NAME>/$PRIVATE_APP/;s/<BUILD_EB_BUCKET>/$BUILD_EB_BUCKET/;s/<AUTH_BUCKET>/$AUTH_BUCKET/" < deploy.sh.TEMPLATE > ~/prv-deploy.sh
      - bash -x ~/prv-deploy.sh
  QA:
    branch: /release.*/
    commands:
      - sed "s/<AWS_REGION>/$QA_AWS_REGION/" < .aws.config.TEMPLATE > ~/.aws/config
      - sed "s/<IMAGE_SHA>/$CIRCLE_SHA1/;s/<BUILD_ENVIRONMENT>/$QA_ENV/;s/<TARGET_DOCKER>/$PUBLIC_DOCKER/;s/<TARGET_DOCKER_DIST>/$PUBLIC_DOCKER_WWW_DIST/;s/<APPLICATION_NAME>/$PUBLIC_APP/;s/<BUILD_EB_BUCKET>/$BUILD_EB_BUCKET/;s/<AUTH_BUCKET>/$AUTH_BUCKET/" < deploy.sh.TEMPLATE > ~/qa-deploy.sh
      - bash -x ~/qa-deploy.sh